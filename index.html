// Modifica√ß√µes para limpar cache e melhorar a experi√™ncia do jogo

// Fun√ß√£o para limpar completamente o localStorage e dados de jogo
function clearGameCache() {
  // Remove todos os itens relacionados ao jogo
  localStorage.removeItem("opoderdedo_gameId");
  localStorage.removeItem("opoderdedo_playerKey");
  localStorage.removeItem("opoderdedo_playerName");
  
  // Desconecta listeners do Firebase
  if (gameCode) {
    db.ref(`games/${gameCode}`).off();
  }
  
  // Limpa vari√°veis globais
  gameCode = null;
  myPlayerKey = null;
  
  // Reseta visualiza√ß√µes
  modeSelect.classList.remove('hidden');
  hostArea.classList.add('hidden');
  playerArea.classList.add('hidden');
  
  // Reseta formul√°rios
  inputGameCodeHost.value = '';
  inputGameCodePlayer.value = '';
  inputPlayerName.value = '';
  
  // Esconde elementos espec√≠ficos de jogo
  hostStep1.classList.remove('hidden');
  hostLobby.classList.add('hidden');
  hostGame.classList.add('hidden');
  playerStep1.classList.remove('hidden');
  playerRegister.classList.add('hidden');
  playerLobby.classList.add('hidden');
  playerGame.classList.add('hidden');
}

// Modifica√ß√£o na fun√ß√£o de finalizar jogo para incluir limpeza de cache
function endGameHost() {
  if (confirm("Tem certeza que deseja encerrar a partida?")) {
    db.ref(`games/${gameCode}`).update({status: 'finished'})
      .then(() => {
        clearGameCache(); // Adiciona limpeza de cache
      })
      .catch(error => alert("Erro ao encerrar partida: " + error.message));
  }
}

// Adicionar fun√ß√£o para recarregar baralho
function reloadDeck() {
  const deck = generateDeck(); // Usa fun√ß√£o existente para gerar novo baralho
  
  db.ref(`games/${gameCode}`).update({
    deck: deck,
    currentCard: null
  })
  .then(() => {
    addLog("üÉè Novo baralho adicionado!");
  })
  .catch(error => {
    alert("Erro ao recarregar baralho: " + error.message);
  });
}

// Adicionar bot√£o de recarregar baralho na interface do host
function addReloadDeckButton() {
  const btnReloadDeck = document.createElement('button');
  btnReloadDeck.id = 'btnReloadDeck';
  btnReloadDeck.className = 'btn-info';
  btnReloadDeck.innerHTML = '<i class="fas fa-redo"></i> Recarregar Baralho';
  btnReloadDeck.onclick = reloadDeck;
  
  // Adicionar pr√≥ximo ao bot√£o de encerrar jogo
  btnEndGame.parentNode.insertBefore(btnReloadDeck, btnEndGame);
}

// Modificar renderHostGame para adicionar suporte a novos bot√µes
function renderHostGame(data) {
  // C√≥digo existente...

  // Adicionar bot√£o de recarregar baralho se n√£o houver cartas
  if (!data.deck || data.deck.length === 0) {
    if (!document.getElementById('btnReloadDeck')) {
      addReloadDeckButton();
    }
  } else {
    const btnReloadDeck = document.getElementById('btnReloadDeck');
    if (btnReloadDeck) {
      btnReloadDeck.remove();
    }
  }

  // C√≥digo existente continua...
}

// Adicionar suporte para usar cartas especiais
function useSpecialCard(cardType) {
  const name = localStorage.getItem("opoderdedo_playerName") || 'Jogador';
  
  if (cardType === 'fingerPower') {
    // Ativa o Poder do Dedo
    db.ref(`games/${gameCode}/fingerPower`).set({
      active: true, 
      owner: myPlayerKey,
      queue: [{playerKey: myPlayerKey, name}]
    });
    
    db.ref(`games/${gameCode}/players/${myPlayerKey}/hasFingerPower`).set(false);
    addLog(`üëÜ ${name} ativou o Poder do Dedo!`);
  }
  
  if (cardType === 'joker') {
    // Usa Coringa para n√£o beber
    db.ref(`games/${gameCode}/players/${myPlayerKey}`).once('value', snap => {
      const p = snap.val();
      if (p.jokers > 0) {
        db.ref(`games/${gameCode}/players/${myPlayerKey}/jokers`).set(p.jokers - 1);
        addLog(`üÉè ${name} usou 1 Coringa para n√£o beber!`);
      }
    });
  }
}

// Exemplo de como adicionar bot√µes para cartas especiais
function addSpecialCardButtons(card) {
  if (card.rank === '8') {
    // Poder do Dedo
    btnActivateFinger.style.display = 'inline-block';
    btnActivateFinger.onclick = () => useSpecialCard('fingerPower');
  }
  
  if (card.rank === 'Joker') {
    // Coringa
    btnUseJoker.style.display = 'inline-block';
    btnUseJoker.onclick = () => useSpecialCard('joker');
  }
}
